# WiFiFly Backend & Database Integration Guide

## Overview

This guide covers the SQLite database backend, API routes, and session management system integrated with the WiFiFly Next.js application.

## Architecture

### Database Schema

The system uses SQLite with three main tables:

**Sessions** (`sessions`)
- `id` (TEXT, PRIMARY KEY): UUID v4 generated by the server
- `created_at` (INTEGER): Unix timestamp in milliseconds

**Setups** (`setups`)
- `id` (TEXT, PRIMARY KEY): UUID v4
- `session_id` (TEXT, FOREIGN KEY → sessions.id)
- `isp` (TEXT): Internet Service Provider name
- `plan_download_mbps` (REAL): Plan download speed in Mbps
- `monthly_cost_nzd` (REAL): Monthly cost in NZ dollars
- `created_at` (INTEGER): Unix timestamp in milliseconds

**Speed Tests** (`speed_tests`)
- `id` (TEXT, PRIMARY KEY): UUID v4
- `session_id` (TEXT, FOREIGN KEY → sessions.id)
- `room_name` (TEXT): Location of the test
- `download_mbps` (REAL): Measured download speed
- `upload_mbps` (REAL): Measured upload speed
- `ping_ms` (REAL): Latency in milliseconds
- `jitter_ms` (REAL): Jitter in milliseconds
- `timestamp` (INTEGER): Unix timestamp in milliseconds

### API Routes

All routes accept JSON and return JSON responses.

#### POST /api/session
Creates a new session. Called automatically when setup page loads.

**Response (201):**
```json
{
  "sessionId": "550e8400-e29b-41d4-a716-446655440000",
  "createdAt": 1731656000000
}
```

**Error (500):**
```json
{
  "error": "Failed to create session"
}
```

---

#### POST /api/setup
Persists setup form data to the database.

**Request:**
```json
{
  "sessionId": "550e8400-e29b-41d4-a716-446655440000",
  "isp": "Spark",
  "planDownloadMbps": 100,
  "monthlyCostNzd": 89.99
}
```

**Response (201):**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440001",
  "sessionId": "550e8400-e29b-41d4-a716-446655440000",
  "isp": "Spark",
  "planDownloadMbps": 100,
  "monthlyCostNzd": 89.99,
  "createdAt": 1731656000000
}
```

**Validation Errors (400):**
- ISP: 1–100 characters, required
- Download Speed: Positive number (> 0)
- Monthly Cost: Non-negative number (≥ 0)

---

#### POST /api/tests
Records a speed test result.

**Request:**
```json
{
  "sessionId": "550e8400-e29b-41d4-a716-446655440000",
  "roomName": "Living Room",
  "downloadMbps": 95.5,
  "uploadMbps": 8.2,
  "pingMs": 12.3,
  "jitterMs": 1.5
}
```

**Response (201):**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440002",
  "sessionId": "550e8400-e29b-41d4-a716-446655440000",
  "roomName": "Living Room",
  "downloadMbps": 95.5,
  "uploadMbps": 8.2,
  "pingMs": 12.3,
  "jitterMs": 1.5,
  "timestamp": 1731656001000,
  "isAnomaly": false
}
```

**Validation Errors (400):**
- Session ID: Must be valid UUID
- Room Name: 1–50 characters
- Speeds/Ping/Jitter: Non-negative numbers

---

#### GET /api/analysis?sessionId=<UUID>
Returns aggregated analysis for a session.

**Response (200):**
```json
{
  "sessionId": "550e8400-e29b-41d4-a716-446655440000",
  "testCount": 3,
  "setup": {
    "id": "550e8400-e29b-41d4-a716-446655440001",
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "isp": "Spark",
    "plan_download_mbps": 100,
    "monthly_cost_nzd": 89.99,
    "created_at": 1731656000000
  },
  "download": {
    "avg": 94.2,
    "min": 92.1,
    "max": 96.5
  },
  "upload": {
    "avg": 8.15,
    "min": 8.0,
    "max": 8.3
  },
  "ping": {
    "avg": 12.2,
    "min": 12.0,
    "max": 12.5
  },
  "jitter": {
    "avg": 1.4,
    "min": 1.3,
    "max": 1.5
  },
  "tests": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440002",
      "roomName": "Living Room",
      "downloadMbps": 95.5,
      "uploadMbps": 8.2,
      "pingMs": 12.3,
      "jitterMs": 1.5,
      "timestamp": 1731656001000
    }
  ]
}
```

**Errors:**
- 400: Missing sessionId parameter
- 404: No test results for this session
- 500: Database error

---

#### GET /api/config
Returns application configuration.

**Response (200):**
```json
{
  "anomalySpeedThreshold": 0.5,
  "version": "1.0.0"
}
```

## Frontend Integration

### Session Management

The setup page automatically manages sessions:

1. **On Mount**: Checks for existing `sessionId` in `localStorage` (key: `wififly_sessionId`)
2. **If Not Found**: Makes `POST /api/session` request to create new session
3. **Storage**: Session ID persists across page refreshes
4. **Retry**: Auto-retries session creation if initial request fails

### Form Submission

When user clicks "Begin Testing" on the final setup step:

1. Form data is validated client-side (Zod schemas)
2. `POST /api/setup` request sent with session ID
3. Loading spinner shown during submission
4. On success: Navigate to `/test` page
5. On error: Display error message, allow retry with exponential backoff (max 3 retries)

### Error Handling

- Network errors are displayed inline without losing user input
- User can edit form and retry submission
- Automatic retry with exponential backoff: 1s, 2s, 4s delays

## Local Development

### Prerequisites

- Node.js 18+
- npm 9+

### Setup

1. **Install dependencies:**
   ```bash
   npm install
   ```

2. **Initialize database (creates schema):**
   ```bash
   npm run migrate
   ```

3. **Seed development data (optional):**
   ```bash
   npm run seed
   ```

4. **Verify database:**
   - Check file exists: `src/db/data/wififly.sqlite`
   - Size: ~28 KB after initialization

### Running

**Development server:**
```bash
npm run dev
```

Visit `http://localhost:3000/setup` to test the setup flow.

**Build for production:**
```bash
npm run build
```

**Run production server:**
```bash
npm start
```

### Testing

**Run all tests:**
```bash
npm test
```

**Watch mode:**
```bash
npm test -- --watch
```

**Coverage:**
```bash
npm test -- --coverage
```

**Current Status:**
- ✅ 19 tests passing
- ✅ Schema validation tests
- ✅ Database operation tests
- ✅ Foreign key constraint tests

## Database Management

### File Location
```
src/db/data/wififly.sqlite
```

### Backup

To back up the database:
```bash
cp src/db/data/wififly.sqlite src/db/data/wififly.sqlite.backup
```

### Reset

To reset the database:
```bash
rm src/db/data/wififly.sqlite
npm run migrate
npm run seed
```

### Query the Database

Using `sqlite3` CLI:
```bash
sqlite3 src/db/data/wififly.sqlite

# View all sessions
SELECT * FROM sessions;

# View all setups
SELECT * FROM setups;

# View speed tests for a session
SELECT * FROM speed_tests WHERE session_id = '<UUID>';

# Aggregated statistics for a session
SELECT
  AVG(download_mbps) as avg_download,
  MIN(download_mbps) as min_download,
  MAX(download_mbps) as max_download,
  COUNT(*) as test_count
FROM speed_tests
WHERE session_id = '<UUID>';
```

## Deployment

### Environment Variables

No environment variables required for SQLite mode. Database file is at:
```
src/db/data/wififly.sqlite
```

### Docker

The Dockerfile includes:
- Database initialization on start
- SQLite3 binaries and dependencies
- Migrations run at build time

Database persists in the container volume at `/app/src/db/data/`.

### Production Considerations

1. **Data Persistence**: Mount Docker volume at `/app/src/db/data/`
2. **Backups**: Regular backups of SQLite file recommended
3. **Scaling**: SQLite works well for single-server deployments (<10k concurrent users)
4. **Future**: For horizontal scaling, migrate to PostgreSQL/MySQL

## Troubleshooting

### Database Connection Errors

**Error:** "Cannot find module 'sqlite3'"
- **Solution:** Run `npm install` to ensure sqlite3 is installed

**Error:** "Cannot open database at path/to/wififly.sqlite"
- **Solution:** Check directory permissions, ensure `/src/db/data/` exists
- **Recovery:** `rm -rf src/db/data && npm run migrate`

### Migration Failures

**Error:** "Table already exists"
- **Solution:** This is normal if running migrate twice. Migrations are idempotent.

**Error:** "Foreign key constraint failed"
- **Solution:** Ensure session exists before creating setup/test records
- **Verify:** Check `src/app/setup/page.tsx` for session creation logic

### Session Not Persisting

**Issue:** Session ID not saved to localStorage
- **Solution:** Check browser localStorage is enabled
- **Debug:** Open DevTools → Application → Local Storage → Check for `wififly_sessionId`

### Tests Failing

**Error:** "Cannot find module 'src/db/client'"
- **Solution:** Run `npm install` then `npm test` again
- **Verify:** Jest config at `jest.config.js` has proper ts-jest setup

## Git Workflow

All backend changes are on the `feat/db-init-migration` branch:

```bash
# View commits
git log --oneline feat/db-init-migration

# View changes in latest commit
git show HEAD

# Merge to main when ready
git checkout main
git merge feat/db-init-migration
```

## Support

For issues:
1. Check error logs: `npm run dev` output
2. Verify database: `npm run migrate`
3. Check tests pass: `npm test`
4. Review this guide: Sections on Troubleshooting and Architecture

## Version History

- **v1.0.0** (2025-11-15): Initial backend integration
  - SQLite database with 3-table schema
  - 5 API routes with Zod validation
  - Session management with localStorage persistence
  - 19 passing integration tests
  - Migration and seed scripts
  - Frontend setup page wiring
